#!/bin/bash

#SBATCH --job-name="train_neural_nets"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="gpuwf"
#SBATCH --nodes=1
#SBATCH --ntasks=8           # 8 tasks per node
#SBATCH --cpus-per-task=2
#SBATCH --ntasks-per-node=8  # 8 GPUs per node
#SBATCH --exclusive
#SBATCH --time=168:00:00
#SBATCH --array=0-1
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=train_neural_nets_%A_%a.out

module load cuda/12.3.1
conda init
conda activate base

echo `which conda`
echo `which python`
echo `which python3`

# PATH=/usr/local/cuda/bin:$PATH
echo $PATH

CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_standalone/ml4rt"
TEMPLATE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_models/spectral_experiment05_final/templates"
TOP_OUTPUT_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_models/spectral_experiment05_final"

MIN_DUAL_WEIGHTS=("0.75" "1.00")
BROADBAND_WEIGHTS=("0.01" "0.05")
NORMALIZATION_TYPE_STRINGS=("old" "new")

min_dual_weight=${MIN_DUAL_WEIGHTS[$SLURM_ARRAY_TASK_ID]}
broadband_weight=${BROADBAND_WEIGHTS[$SLURM_ARRAY_TASK_ID]}
normalization_type_string=${NORMALIZATION_TYPE_STRINGS[$SLURM_ARRAY_TASK_ID]}

if [ "$normalization_type_string" == "old" ]; then
    TRAINING_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/gfs_data/examples_with_correct_vertical_coords/shortwave_spectrally_resolved/normalized_predictors/training"
    VALIDATION_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/gfs_data/examples_with_correct_vertical_coords/shortwave_spectrally_resolved/normalized_predictors/validation"
    NORMALIZATION_FILE_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/gfs_data/examples_with_correct_vertical_coords/shortwave_spectrally_resolved/training/learning_examples_for_norm_20180901-20191221.nc"
else
    TRAINING_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/gfs_data/examples_with_correct_vertical_coords/shortwave_spectrally_resolved/normalized_predictors/simple_normalization/training"
    VALIDATION_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/gfs_data/examples_with_correct_vertical_coords/shortwave_spectrally_resolved/normalized_predictors/simple_normalization/validation"
    NORMALIZATION_FILE_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/gfs_data/examples_with_correct_vertical_coords/shortwave_spectrally_resolved/training/normalization_params_20180901-20191221.nc"
fi

template_file_name="${TEMPLATE_DIR_NAME}/min-dual-weight=${min_dual_weight}_broadband-weight=${broadband_weight}_normalization-type=${normalization_type_string}/model.keras"
output_dir_name="${TOP_OUTPUT_DIR_NAME}/min-dual-weight=${min_dual_weight}_broadband-weight=${broadband_weight}_normalization-type=${normalization_type_string}"
echo $output_dir_name

python3 -u "${CODE_DIR_NAME}/train_neural_net.py" \
--input_training_dir_name="${TRAINING_DIR_NAME}" \
--input_validation_dir_name="${VALIDATION_DIR_NAME}" \
--input_normalization_file_name="${NORMALIZATION_FILE_NAME}" \
--input_model_file_name="${template_file_name}" \
--output_model_dir_name="${output_dir_name}" \
--use_generator_for_training=1 \
--use_generator_for_validn=1 \
--predictor_names "zenith_angle_radians" "albedo" "aerosol_single_scattering_albedo" "aerosol_asymmetry_param" "pressure_pascals" "temperature_kelvins" "specific_humidity_kg_kg01" "relative_humidity_unitless" "liquid_water_content_kg_m03" "ice_water_content_kg_m03" "liquid_water_path_kg_m02" "ice_water_path_kg_m02" "vapour_path_kg_m02" "upward_liquid_water_path_kg_m02" "upward_ice_water_path_kg_m02" "upward_vapour_path_kg_m02" "liquid_effective_radius_metres" "ice_effective_radius_metres" "o3_mixing_ratio_kg_kg01" "co2_concentration_ppmv" "ch4_concentration_ppmv" "n2o_concentration_ppmv" "aerosol_extinction_metres01" "height_m_agl" "height_thickness_metres" "pressure_thickness_pascals" \
--target_names "shortwave_heating_rate_k_day01" "shortwave_surface_down_flux_w_m02" "shortwave_toa_up_flux_w_m02" \
--heights_m_agl 21 44 68 93 120 149 179 212 246 282 321 361 405 450 499 550 604 661 722 785 853 924 999 1078 1161 1249 1342 1439 1542 1649 1762 1881 2005 2136 2272 2415 2564 2720 2882 3051 3228 3411 3601 3798 4002 4214 4433 4659 4892 5132 5379 5633 5894 6162 6436 6716 7003 7296 7594 7899 8208 8523 8842 9166 9494 9827 10164 10505 10849 11198 11550 11906 12266 12630 12997 13368 13744 14123 14506 14895 15287 15686 16090 16501 16920 17350 17791 18246 18717 19205 19715 20249 20809 21400 22022 22681 23379 24119 24903 25736 26619 27558 28556 29616 30743 31940 33211 34566 36012 37560 39218 40990 42882 44899 47042 49299 51644 54067 56552 59089 61677 64314 67001 69747 72521 75256 77803 \
--target_wavelengths_metres 0.000005847953216 0.000003418803419 0.000002758620690 0.000002312138728 0.000002040816327 0.000001769911504 0.000001444043321 0.000001269841270 0.000000956937799 0.000000693240901 0.000000517464424 0.000000387221684 0.000000298507463 0.000000227272727 \
--first_training_time_string="2018-09-01-000000" \
--last_training_time_string="2019-12-21-235959" \
--first_validn_time_string="2019-12-24-000000" \
--last_validn_time_string="2020-12-31-235959" \
--normalize_predictors=1 \
--normalize_vector_targets=0 \
--normalize_scalar_targets=0 \
--num_examples_per_batch=724 \
--num_epochs=1000 \
--num_training_batches_per_epoch=1000 \
--num_validn_batches_per_epoch=1000 \
--early_stopping_patience_epochs=10000 \
--plateau_lr_multiplier=0.9 \
--num_deep_supervision_layers=0 \
--normalization_file_name_for_mask="${NORMALIZATION_FILE_NAME}" \
--min_heating_rate_for_mask_k_day01=0.001 \
--min_flux_for_mask_w_m02=0.01
