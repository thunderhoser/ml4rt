#!/bin/tcsh

#SBATCH --job-name="evaluate_by_cloud_regime"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="batch"
#SBATCH --ntasks=1
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=16G
##SBATCH --nodes=1
##SBATCH --ntasks=1
##SBATCH --cpus-per-task=1
##SBATCH --ntasks-per-node=1
#SBATCH --time=02:00:00
#SBATCH --array=1-144
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=evaluate_by_cloud_regime_%A_%a.out

module load cuda/10.1
source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_standalone_sr/ml4rt"
set TOP_MODEL_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_models/experiment04"
set EXAMPLE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/examples/new_locations"

set DENSE_LAYER_COUNTS=(2 2 2 2 2 2 3 3 3 3 3 3 4 4 4 4 4 4 5 5 5 5 5 5 2 2 2 2 2 2 3 3 3 3 3 3 4 4 4 4 4 4 5 5 5 5 5 5 2 2 2 2 2 2 3 3 3 3 3 3 4 4 4 4 4 4 5 5 5 5 5 5 2 2 2 2 2 2 3 3 3 3 3 3 4 4 4 4 4 4 5 5 5 5 5 5 2 2 2 2 2 2 3 3 3 3 3 3 4 4 4 4 4 4 5 5 5 5 5 5 2 2 2 2 2 2 3 3 3 3 3 3 4 4 4 4 4 4 5 5 5 5 5 5)
set DENSE_LAYER_DROPOUT_RATES=(0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.125 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.250 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.375 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.625 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750 0.750)
set SCALAR_LOSS_FUNCTION_WEIGHTS=(1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0 1.0 2.5 5.0 10.0 25.0 50.0)

set dense_layer_count=${DENSE_LAYER_COUNTS[$SLURM_ARRAY_TASK_ID]}
set dense_layer_dropout_rate=${DENSE_LAYER_DROPOUT_RATES[$SLURM_ARRAY_TASK_ID]}
set scalar_loss_function_weight=${SCALAR_LOSS_FUNCTION_WEIGHTS[$SLURM_ARRAY_TASK_ID]}

set dense_layer_count_string=`printf "%d" $dense_layer_count`
set dense_layer_dropout_string=`printf "%.3f" $dense_layer_dropout_rate`
set scalar_loss_function_weight_string=`printf "%05.1f" $scalar_loss_function_weight`
set top_model_dir_name="${TOP_MODEL_DIR_NAME}/num-dense-layers=${dense_layer_count_string}_dense-dropout=${dense_layer_dropout_string}_scalar-lf-weight=${scalar_loss_function_weight_string}"

set neural_net_file_names={${top_model_dir_name}/model*.h5}
set neural_net_file_name=${neural_net_file_names[$#neural_net_file_names]}
set model_dir_name=`echo $neural_net_file_name | rev | cut -c 4- | rev`

set base_model_validation_dir_name="${model_dir_name}/validation_new_locations"
set isotonic_validation_dir_name="${model_dir_name}/isotonic_regression/validation_new_locations"
set main_isotonic_prediction_file_name="${isotonic_validation_dir_name}/predictions.nc"

python3 -u "${CODE_DIR_NAME}/split_predictions_by_cloud.py" \
--input_prediction_file_name="${main_isotonic_prediction_file_name}" \
--input_example_dir_name="${EXAMPLE_DIR_NAME}" \
--for_ice=0 \
--min_path_kg_m02=0.025 \
--output_prediction_dir_name="${isotonic_validation_dir_name}/by_cloud_regime"

set isotonic_prediction_file_names=("${isotonic_validation_dir_name}/by_cloud_regime/predictions_no-cloud.nc" "${isotonic_validation_dir_name}/by_cloud_regime/predictions_single-layer-cloud.nc" "${isotonic_validation_dir_name}/by_cloud_regime/predictions_multi-layer-cloud.nc")
set isotonic_prediction_dir_names=("${isotonic_validation_dir_name}/by_cloud_regime/no_cloud" "${isotonic_validation_dir_name}/by_cloud_regime/single_layer_cloud" "${isotonic_validation_dir_name}/by_cloud_regime/multi_layer_cloud")
set isotonic_eval_file_names=("${isotonic_validation_dir_name}/by_cloud_regime/no_cloud/evaluation.nc" "${isotonic_validation_dir_name}/by_cloud_regime/single_layer_cloud/evaluation.nc" "${isotonic_validation_dir_name}/by_cloud_regime/multi_layer_cloud/evaluation.nc")
set isotonic_eval_dir_name="${isotonic_validation_dir_name}/by_cloud_regime/evaluation"
set base_model_eval_file_names=("${base_model_validation_dir_name}/by_cloud_regime/no_cloud/evaluation.nc" "${base_model_validation_dir_name}/by_cloud_regime/single_layer_cloud/evaluation.nc" "${base_model_validation_dir_name}/by_cloud_regime/multi_layer_cloud/evaluation.nc")

set i=1

while ($i <= ${#isotonic_prediction_file_names})
    python3 -u "${CODE_DIR_NAME}/evaluate_neural_net.py" \
    --input_prediction_file_name="${isotonic_prediction_file_names[$i]}" \
    --output_dir_name="${isotonic_prediction_dir_names[$i]}"

    @ i = $i + 1
end

# python3 -u "${CODE_DIR_NAME}/plot_evaluation.py" \
# --input_eval_file_names "${isotonic_eval_file_names[1]}" "${base_model_eval_file_names[1]}" "${isotonic_eval_file_names[2]}" "${base_model_eval_file_names[2]}" "${isotonic_eval_file_names[3]}" "${base_model_eval_file_names[3]}" \
# --line_styles "solid" "dashed" "solid" "dashed" "solid" "dashed" \
# --line_colours "27_158_119" "27_158_119" "217_95_2" "217_95_2" "117_112_179" "117_112_179" \
# --line_legend_strings "No_cloud_(IR)" "No_cloud_(base)" "Single-layer_cloud_(IR)" "Single-layer_cloud_(base)" "Multi-layer_cloud_(IR)" "Multi-layer_cloud_(base)" \
# --use_log_scale=1 \
# --plot_by_height=1 \
# --output_dir_name="${isotonic_eval_dir_name}"

python3 -u "${CODE_DIR_NAME}/plot_evaluation.py" \
--input_eval_file_names "${isotonic_eval_file_names[1]}" "${isotonic_eval_file_names[2]}" "${isotonic_eval_file_names[3]}" \
--line_styles "solid" "solid" "solid" \
--line_colours "27_158_119" "217_95_2" "117_112_179" \
--line_legend_strings "No_cloud" "Single-layer_cloud" "Multi-layer_cloud" \
--use_log_scale=1 \
--plot_by_height=1 \
--output_dir_name="${isotonic_eval_dir_name}"
