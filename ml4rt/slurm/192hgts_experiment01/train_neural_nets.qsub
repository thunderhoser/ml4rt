#!/bin/tcsh

#SBATCH --job-name="train_neural_nets"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="batch"
#SBATCH --nodes=1
#SBATCH --ntasks=8           # 8 tasks per node
#SBATCH --cpus-per-task=2
#SBATCH --ntasks-per-node=8  # 8 GPUs per node
#SBATCH --exclusive
#SBATCH --time=30:00:00
#SBATCH --array=1-216%75
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=train_neural_nets_%A_%a.out

module load cuda/10.1
source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_standalone_sr/ml4rt"
set TOP_TEMPLATE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_models/192heights/experiment01/templates"
set TOP_OUTPUT_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_models/192heights/experiment01"

set TRAINING_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/examples/192heights/non_tropical_sites"
set VALIDATION_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/examples/192heights/non_tropical_sites"
set NORMALIZATION_FILE_NAME="${TRAINING_DIR_NAME}/learning_examples_2018_for-norm.nc"

set DENSE_LAYER_COUNTS=(2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 5 5 5 5 5 5 5 5 5 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 5 5 5 5 5 5 5 5 5 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 5 5 5 5 5 5 5 5 5 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 5 5 5 5 5 5 5 5 5 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 5 5 5 5 5 5 5 5 5 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 4 4 4 5 5 5 5 5 5 5 5 5)
set DENSE_LAYER_DROPOUT_RATES=(0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.100 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.200 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.300 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.400 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500 0.500)
set L2_WEIGHTS=(0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000 0.0000001000 0.0000003162 0.0000010000 0.0000031623 0.0000100000 0.0000316228 0.0001000000 0.0003162278 0.0010000000)

set dense_layer_count=${DENSE_LAYER_COUNTS[$SLURM_ARRAY_TASK_ID]}
set dense_layer_dropout_rate=${DENSE_LAYER_DROPOUT_RATES[$SLURM_ARRAY_TASK_ID]}
set l2_weight=${L2_WEIGHTS[$SLURM_ARRAY_TASK_ID]}

set dense_layer_count_string=`printf "%d" $dense_layer_count`
set dense_layer_dropout_string=`printf "%.3f" $dense_layer_dropout_rate`
set l2_weight_string=`printf "%.10f" $l2_weight`

set template_file_name="${TOP_TEMPLATE_DIR_NAME}/num-dense-layers=${dense_layer_count_string}_dense-dropout=${dense_layer_dropout_string}_l2-weight=${l2_weight_string}/model.h5"
set output_dir_name="${TOP_OUTPUT_DIR_NAME}/num-dense-layers=${dense_layer_count_string}_dense-dropout=${dense_layer_dropout_string}_l2-weight=${l2_weight_string}"
echo $output_dir_name

python3 -u "${CODE_DIR_NAME}/train_neural_net.py" \
--net_type_string="u_net" \
--input_training_dir_name="${TRAINING_DIR_NAME}" \
--input_validation_dir_name="${VALIDATION_DIR_NAME}" \
--input_normalization_file_name="${NORMALIZATION_FILE_NAME}" \
--input_model_file_name="${template_file_name}" \
--output_model_dir_name="${output_dir_name}" \
--use_generator_for_training=0 \
--use_generator_for_validn=0 \
--target_names "shortwave_heating_rate_k_day01" "shortwave_surface_down_flux_w_m02" "shortwave_toa_up_flux_w_m02" \
--heights_m_agl 10 17 23 30 36 43 49 56 62 69 76 82 89 95 102 108 115 121 128 134 141 148 154 161 167 174 180 187 193 200 208 217 225 233 242 250 258 267 275 283 292 300 317 333 350 367 383 400 417 433 450 467 483 500 533 567 600 633 667 700 733 767 800 833 867 900 933 967 1000 1033 1067 1100 1133 1167 1200 1233 1267 1300 1333 1367 1400 1433 1467 1500 1533 1567 1600 1633 1667 1700 1733 1767 1800 1833 1867 1900 1933 1967 2000 2067 2133 2200 2267 2333 2400 2467 2533 2600 2667 2733 2800 2867 2933 3000 3067 3133 3200 3267 3333 3400 3467 3533 3600 3667 3733 3800 3867 3933 4000 4067 4133 4200 4267 4333 4400 4467 4533 4600 4667 4733 4800 4867 4933 5000 5167 5333 5500 5667 5833 6000 6167 6333 6500 6667 6833 7000 7333 7667 8000 8333 8667 9000 9333 9667 10000 10333 10667 11000 11333 11667 12000 12333 12667 13000 13333 13667 14000 14333 14667 15000 18000 20000 22000 24000 27000 30000 33000 36000 39000 42000 46000 50000 \
--omit_heating_rate=0 \
--first_training_time_string="2018-01-01-000000" \
--last_training_time_string="2018-12-24-235959" \
--first_validn_time_string="2019-01-01-000000" \
--last_validn_time_string="2019-12-24-235959" \
--vector_target_norm_type_string='' \
--scalar_target_norm_type_string='minmax' \
--scalar_target_min_norm_value=0 \
--scalar_target_max_norm_value=1 \
--num_examples_per_batch=256 \
--plateau_lr_multiplier=0.6
