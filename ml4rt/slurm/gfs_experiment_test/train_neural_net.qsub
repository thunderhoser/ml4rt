#!/bin/tcsh

#SBATCH --job-name="train_neural_net"
#SBATCH --partition="fge"
#SBATCH --account="rda-ghpcs"
#SBATCH --qos="batch"
#SBATCH --nodes=1
#SBATCH --ntasks=8           # 8 tasks per node
#SBATCH --cpus-per-task=2
#SBATCH --ntasks-per-node=8  # 8 GPUs per node
#SBATCH --exclusive
#SBATCH --time=30:00:00
#SBATCH --exclude=h28n12
##SBATCH --exclude=h31n03,h28n12
##SBATCH --exclude=h29n01,h26n05,h28n06,h29n07,h30n03,h30n15
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=ryan.lagerquist@noaa.gov
#SBATCH --output=train_neural_net_%A.out

module load cuda/10.1
source /scratch2/BMC/gsd-hpcs/Jebb.Q.Stewart/conda3.7/etc/profile.d/conda.csh
conda activate base

set CODE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_standalone/ml4rt"
set TEMPLATE_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_models/gfs/test/template"
set OUTPUT_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_models/gfs/test"

set TRAINING_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/gfs_data/examples/new_heights/training"
set VALIDATION_DIR_NAME="/scratch1/RDARCH/rda-ghpcs/Ryan.Lagerquist/ml4rt_project/gfs_data/examples/new_heights/validation"
set NORMALIZATION_FILE_NAME="${TRAINING_DIR_NAME}/learning_examples_for_norm.nc"

set template_file_name="${TEMPLATE_DIR_NAME}/model.h5"

python3 -u "${CODE_DIR_NAME}/train_neural_net.py" \
--net_type_string="u_net" \
--input_training_dir_name="${TRAINING_DIR_NAME}" \
--input_validation_dir_name="${VALIDATION_DIR_NAME}" \
--input_normalization_file_name="${NORMALIZATION_FILE_NAME}" \
--input_model_file_name="${template_file_name}" \
--output_model_dir_name="${OUTPUT_DIR_NAME}" \
--use_generator_for_training=0 \
--use_generator_for_validn=0 \
--predictor_names "zenith_angle_radians" "albedo" "pressure_pascals" "temperature_kelvins" "specific_humidity_kg_kg01" "relative_humidity_unitless" "liquid_water_content_kg_m03" "ice_water_content_kg_m03" "liquid_water_path_kg_m02" "ice_water_path_kg_m02" "vapour_path_kg_m02" "upward_liquid_water_path_kg_m02" "upward_ice_water_path_kg_m02" "upward_vapour_path_kg_m02" "liquid_effective_radius_metres" "ice_effective_radius_metres" "o3_mixing_ratio_kg_kg01" "co2_concentration_ppmv" "ch4_concentration_ppmv" "n2o_concentration_ppmv" "aerosol_extinction_metres01" \
--target_names "shortwave_heating_rate_k_day01" "shortwave_surface_down_flux_w_m02" "shortwave_toa_up_flux_w_m02" \
--heights_m_agl 8 23 37 52 67 81 96 111 125 140 155 170 184 199 214 229 244 259 274 289 304 319 334 349 365 380 395 410 426 441 457 472 487 503 518 534 550 565 581 596 612 628 644 659 675 691 707 723 739 755 771 787 803 820 836 852 868 885 901 917 934 950 967 983 1000 1016 1033 1050 1066 1083 1100 1117 1134 1151 1167 1184 1201 1219 1236 1253 1270 1287 1304 1322 1339 1357 1374 1391 1409 1427 1444 1462 1479 1497 1515 1533 1551 1568 1586 1604 1622 1641 1659 1677 1695 1713 1732 1750 1768 1787 1805 1824 1842 1861 1880 1898 1917 1936 1955 1974 1993 2012 2031 2050 2069 2088 2107 2127 2146 2166 2185 2205 2224 2244 2263 2283 2303 2323 2343 2363 2383 2403 2423 2443 2463 2483 2504 2524 2545 2565 2586 2606 2627 2648 2668 2689 2710 2731 2752 2773 2794 2816 2837 2858 2880 2901 2923 2944 2966 2987 3009 3031 3053 3075 3097 3119 3141 3164 3186 3208 3231 3253 3276 3298 3321 3344 3367 3390 3413 3436 3459 3482 3505 3529 3552 3576 3599 3623 3647 3671 3694 3718 3743 3767 3791 3815 3840 3864 3889 3913 3938 3963 3988 4013 4038 4063 4088 4113 4139 4164 4190 4215 4241 4267 4293 4319 4345 4371 4397 4424 4450 4477 4504 4530 4557 4584 4611 4639 4666 4693 4721 4748 4776 4804 4832 4860 4888 4916 4944 4973 5001 5030 5059 5088 5117 5146 5175 5204 5234 5263 5293 5323 5353 5383 5413 5444 5474 5505 5535 5566 5597 5628 5659 5691 5722 5754 5786 5817 5850 5882 5914 5947 5979 6012 6045 6078 6111 6144 6178 6212 6245 6279 6313 6348 6382 6417 6452 6487 6522 6557 6592 6628 6664 6700 6736 6772 6809 6845 6882 6919 6957 6994 7032 7070 7108 7146 7184 7223 7262 7301 7340 7379 7419 7459 7499 7539 7580 7621 7662 7703 7744 7786 7828 7870 7913 7955 7998 8041 8085 8128 8172 8217 8261 8306 8351 8396 8442 8487 8534 8580 8627 8674 8721 8769 8817 8865 8914 8963 9012 9061 9111 9162 9212 9263 9314 9366 9418 9471 9523 9577 9630 9684 9738 9793 9848 9904 9960 10016 10073 10131 10188 10247 10305 10365 10424 10484 10545 10606 10668 10730 10793 10856 10920 10984 11042 11099 11156 11214 11272 11331 11390 11450 11510 11571 11633 11695 11758 11821 11885 11950 12015 12081 12148 12215 12284 12352 12422 12493 12564 12636 12709 12783 12857 12933 13009 13086 13165 13244 13324 13405 13488 13571 13656 13741 13828 13916 14006 14096 14188 14281 14376 14472 14570 14669 14769 14872 14976 15081 15189 15298 15409 15522 15638 15755 15875 15997 16121 16248 16377 16509 16644 16782 16923 17067 17215 17365 17520 17679 17841 18008 18179 18355 18537 18723 18915 19113 19318 19529 19748 19974 20215 20465 20726 20997 21280 21576 21887 22212 22555 22917 23300 23707 24141 24607 25108 25134 25160 25186 25213 25239 25266 25293 25319 25346 25373 25401 25428 25455 25483 25511 25538 25566 25594 25623 25651 25679 25708 25736 25765 25794 25823 25852 25881 25911 25940 25970 26000 26030 26060 26090 26121 26151 26182 26213 26244 26275 26306 26337 26369 26401 26432 26464 26497 26529 26561 26594 26627 26660 26693 26726 26760 26794 26827 26861 26896 26930 26965 26999 27034 27069 27105 27140 27176 27212 27248 27284 27321 27357 27394 27431 27469 27506 27544 27582 27620 27659 27697 27736 27776 27815 27854 27894 27934 27975 28015 28056 28097 28139 28180 28222 28264 28307 28350 28393 28436 28479 28523 28568 28612 28657 28702 28747 28793 28839 28885 28932 28979 29027 29074 29122 29171 29220 29269 29318 29368 29419 29469 29520 29572 29624 29676 29729 29782 29836 29890 29944 29999 30055 30111 30167 30224 30281 30339 30398 30457 30516 30576 30637 30698 30760 30822 30885 30949 31013 31078 31143 31209 31276 31344 31412 31481 31551 31621 31692 31764 31837 31911 31985 32068 32153 32239 32327 32415 32504 32595 32687 32779 32874 32969 33065 33163 33262 33363 33465 33568 33673 33780 33888 33997 34109 34222 34336 34453 34572 34692 34815 34939 35066 35195 35327 35460 35597 35735 35877 36021 36169 36319 36472 36629 36789 36953 37121 37292 37468 37648 37833 38022 38217 38416 38622 38833 39051 39275 39506 39745 39993 40248 40514 40789 41075 41372 41682 42007 42346 42701 43075 43470 43886 44328 44799 45302 45842 46425 47065 47820 48655 49588 50646 51774 53063 54641 56675 59542 64443 69345 \
--first_training_time_string="2019-12-01-000000" \
--last_training_time_string="2020-03-13-235959" \
--first_validn_time_string="2020-03-16-000000" \
--last_validn_time_string="2020-04-15-235959" \
--vector_target_norm_type_string='' \
--scalar_target_norm_type_string='minmax' \
--scalar_target_min_norm_value=0 \
--scalar_target_max_norm_value=1 \
--num_examples_per_batch=256 \
--plateau_lr_multiplier=0.6
